let dataJson = {"options":{"default":"Alegeti caracteristica","firstCharact":"Investitii","secondCharact":"Inflatia","thirdCharact":"Cost ora de munca"},"data":[{"year":1982,"countries":[{"name":"Romania","firstCharact":19.8,"secondCharact":43.1,"thirdCharact":2},{"name":"Ungaria","firstCharact":10,"secondCharact":12,"thirdCharact":10},{"name":"Bulgaria","firstCharact":34.1,"secondCharact":1.92,"thirdCharact":8.7}]},{"year":1983,"countries":[{"name":"Romania","firstCharact":22.6,"secondCharact":43.1,"thirdCharact":2.3},{"name":"Ungaria","firstCharact":20,"secondCharact":8.9,"thirdCharact":6.8},{"name":"Bulgaria","firstCharact":32.9,"secondCharact":0.64,"thirdCharact":6.6}]},{"year":1984,"countries":[{"name":"Romania","firstCharact":22.5,"secondCharact":22.6,"thirdCharact":4},{"name":"Ungaria","firstCharact":140,"secondCharact":12.7,"thirdCharact":8},{"name":"Bulgaria","firstCharact":33.2,"secondCharact":2.7,"thirdCharact":2.8}]},{"year":1985,"countries":[{"name":"Romania","firstCharact":22.7,"secondCharact":23.4,"thirdCharact":3},{"name":"Ungaria","firstCharact":80,"secondCharact":12.7,"thirdCharact":8.9},{"name":"Bulgaria","firstCharact":32.2,"secondCharact":0.22,"thirdCharact":3.4}]},{"year":1986,"countries":[{"name":"Romania","firstCharact":24.3,"secondCharact":15.5,"thirdCharact":4.5},{"name":"Ungaria","firstCharact":78.7,"secondCharact":12.2,"thirdCharact":5.9},{"name":"Bulgaria","firstCharact":35.9,"secondCharact":1.35,"thirdCharact":7}]},{"year":1987,"countries":[{"name":"Romania","firstCharact":23.9,"secondCharact":12.1,"thirdCharact":8},{"name":"Ungaria","firstCharact":27.9,"secondCharact":13,"thirdCharact":7.8},{"name":"Bulgaria","firstCharact":32.9,"secondCharact":0.645,"thirdCharact":2.9}]},{"year":1988,"countries":[{"name":"Romania","firstCharact":27.2,"secondCharact":10.5,"thirdCharact":8.5},{"name":"Ungaria","firstCharact":78.12,"secondCharact":8.1,"thirdCharact":7},{"name":"Bulgaria","firstCharact":34.4,"secondCharact":5.33,"thirdCharact":5.33}]},{"year":1989,"countries":[{"name":"Romania","firstCharact":31.1,"secondCharact":15.7,"thirdCharact":2.3},{"name":"Ungaria","firstCharact":19.9,"secondCharact":8.43,"thirdCharact":8.12},{"name":"Bulgaria","firstCharact":31.1,"secondCharact":6.73,"thirdCharact":6.23}]},{"year":1990,"countries":[{"name":"Romania","firstCharact":33.2,"secondCharact":15.9,"thirdCharact":10},{"name":"Ungaria","firstCharact":112.5,"secondCharact":28.1,"thirdCharact":7.8},{"name":"Bulgaria","firstCharact":25.6,"secondCharact":26.2,"thirdCharact":6.1}]},{"year":1991,"countries":[{"name":"Romania","firstCharact":26.6,"secondCharact":3.97,"thirdCharact":5.9},{"name":"Ungaria","firstCharact":70.8,"secondCharact":29.1,"thirdCharact":10.3},{"name":"Bulgaria","firstCharact":22.6,"secondCharact":227,"thirdCharact":4.5}]},{"year":1992,"countries":[{"name":"Romania","firstCharact":27.1,"secondCharact":3.53,"thirdCharact":12},{"name":"Ungaria","firstCharact":67.5,"secondCharact":21.5,"thirdCharact":3.4},{"name":"Bulgaria","firstCharact":19.9,"secondCharact":59.6,"thirdCharact":2.9}]},{"year":1993,"countries":[{"name":"Romania","firstCharact":28,"secondCharact":4.01,"thirdCharact":9.8},{"name":"Ungaria","firstCharact":12.9,"secondCharact":21.3,"thirdCharact":4.5},{"name":"Bulgaria","firstCharact":15.3,"secondCharact":51.1,"thirdCharact":3.4}]},{"year":1994,"countries":[{"name":"Romania","firstCharact":26.8,"secondCharact":4.63,"thirdCharact":4.9},{"name":"Ungaria","firstCharact":22.4,"secondCharact":19.7,"thirdCharact":5.1},{"name":"Bulgaria","firstCharact":9.39,"secondCharact":72.7,"thirdCharact":3.12}]},{"year":1995,"countries":[{"name":"Romania","firstCharact":25.6,"secondCharact":3.42,"thirdCharact":8.2},{"name":"Ungaria","firstCharact":40.3,"secondCharact":19.5,"thirdCharact":4.45},{"name":"Bulgaria","firstCharact":15.7,"secondCharact":62.4,"thirdCharact":4.59}]},{"year":1996,"countries":[{"name":"Romania","firstCharact":24.7,"secondCharact":1.69,"thirdCharact":15},{"name":"Ungaria","firstCharact":45.9,"secondCharact":22,"thirdCharact":4.89},{"name":"Bulgaria","firstCharact":0.3,"secondCharact":103,"thirdCharact":2.1}]},{"year":1997,"countries":[{"name":"Romania","firstCharact":25.2,"secondCharact":2.59,"thirdCharact":2.3},{"name":"Ungaria","firstCharact":67.8,"secondCharact":20,"thirdCharact":5},{"name":"Bulgaria","firstCharact":8.87,"secondCharact":110,"thirdCharact":2.2}]},{"year":1998,"countries":[{"name":"Romania","firstCharact":24,"secondCharact":2.05,"thirdCharact":7.8},{"name":"Ungaria","firstCharact":64.5,"secondCharact":13.6,"thirdCharact":7},{"name":"Bulgaria","firstCharact":18.5,"secondCharact":32.3,"thirdCharact":3.89}]},{"year":1999,"countries":[{"name":"Romania","firstCharact":24.4,"secondCharact":5.28,"thirdCharact":3.2},{"name":"Ungaria","firstCharact":78.2,"secondCharact":8.07,"thirdCharact":5.23},{"name":"Bulgaria","firstCharact":19.3,"secondCharact":2.44,"thirdCharact":4.45}]},{"year":2000,"countries":[{"name":"Romania","firstCharact":19.8,"secondCharact":43.1,"thirdCharact":4.48},{"name":"Ungaria","firstCharact":89.21,"secondCharact":9.86,"thirdCharact":6.12},{"name":"Bulgaria","firstCharact":19.2,"secondCharact":7.32,"thirdCharact":6.12}]},{"year":2001,"countries":[{"name":"Romania","firstCharact":22.6,"secondCharact":43.1,"thirdCharact":4.91},{"name":"Ungaria","firstCharact":50.2,"secondCharact":11.6,"thirdCharact":7.02},{"name":"Bulgaria","firstCharact":21.5,"secondCharact":6.11,"thirdCharact":6.05}]},{"year":2002,"countries":[{"name":"Romania","firstCharact":22.5,"secondCharact":22.6,"thirdCharact":5.25},{"name":"Ungaria","firstCharact":45.8,"secondCharact":8.36,"thirdCharact":7.1},{"name":"Bulgaria","firstCharact":20.7,"secondCharact":3.77,"thirdCharact":6.45}]},{"year":2003,"countries":[{"name":"Romania","firstCharact":22.7,"secondCharact":23.4,"thirdCharact":5.08},{"name":"Ungaria","firstCharact":89.2,"secondCharact":5.54,"thirdCharact":11.1},{"name":"Bulgaria","firstCharact":22.2,"secondCharact":2.27,"thirdCharact":4.94}]},{"year":2004,"countries":[{"name":"Romania","firstCharact":24.3,"secondCharact":15.5,"thirdCharact":5.67},{"name":"Ungaria","firstCharact":123.8,"secondCharact":4.99,"thirdCharact":10.3},{"name":"Bulgaria","firstCharact":23.6,"secondCharact":5.66,"thirdCharact":5.1}]},{"year":2005,"countries":[{"name":"Romania","firstCharact":23.9,"secondCharact":12.1,"thirdCharact":6.16},{"name":"Ungaria","firstCharact":78.8,"secondCharact":2.43,"thirdCharact":12.1},{"name":"Bulgaria","firstCharact":27.9,"secondCharact":6.51,"thirdCharact":5.28}]},{"year":2006,"countries":[{"name":"Romania","firstCharact":27.2,"secondCharact":10.5,"thirdCharact":7.1},{"name":"Ungaria","firstCharact":70,"secondCharact":3.54,"thirdCharact":13.1},{"name":"Bulgaria","firstCharact":32.3,"secondCharact":6.74,"thirdCharact":5.4}]},{"year":2007,"countries":[{"name":"Romania","firstCharact":31.1,"secondCharact":15.7,"thirdCharact":7.96},{"name":"Ungaria","firstCharact":76,"secondCharact":5.41,"thirdCharact":13.8},{"name":"Bulgaria","firstCharact":33.6,"secondCharact":11.1,"thirdCharact":5.84}]},{"year":2008,"countries":[{"name":"Romania","firstCharact":33.2,"secondCharact":15.9,"thirdCharact":8},{"name":"Ungaria","firstCharact":89.2,"secondCharact":5,"thirdCharact":6.5},{"name":"Bulgaria","firstCharact":37,"secondCharact":8.13,"thirdCharact":6.94}]},{"year":2009,"countries":[{"name":"Romania","firstCharact":26.6,"secondCharact":3.97,"thirdCharact":9.03},{"name":"Ungaria","firstCharact":58.75,"secondCharact":4.04,"thirdCharact":15.8},{"name":"Bulgaria","firstCharact":28.6,"secondCharact":4.05,"thirdCharact":7.56}]},{"year":2010,"countries":[{"name":"Romania","firstCharact":27.1,"secondCharact":3.53,"thirdCharact":9.39},{"name":"Ungaria","firstCharact":89.1,"secondCharact":2.33,"thirdCharact":15.3},{"name":"Bulgaria","firstCharact":22.6,"secondCharact":1.11,"thirdCharact":8.32}]},{"year":2011,"countries":[{"name":"Romania","firstCharact":28,"secondCharact":4.01,"thirdCharact":9.63},{"name":"Ungaria","firstCharact":67.8,"secondCharact":2.27,"thirdCharact":15.3},{"name":"Bulgaria","firstCharact":21.5,"secondCharact":5.98,"thirdCharact":8.52}]},{"year":2012,"countries":[{"name":"Romania","firstCharact":26.8,"secondCharact":4.63,"thirdCharact":11.8},{"name":"Ungaria","firstCharact":41.12,"secondCharact":3.38,"thirdCharact":17.7},{"name":"Bulgaria","firstCharact":21.9,"secondCharact":1.56,"thirdCharact":9.67}]},{"year":2013,"countries":[{"name":"Romania","firstCharact":25.6,"secondCharact":3.42,"thirdCharact":12.1},{"name":"Ungaria","firstCharact":56.89,"secondCharact":2.94,"thirdCharact":18.4},{"name":"Bulgaria","firstCharact":21.3,"secondCharact":0.7,"thirdCharact":10.3}]},{"year":2014,"countries":[{"name":"Romania","firstCharact":24.7,"secondCharact":1.69,"thirdCharact":12.6},{"name":"Ungaria","firstCharact":77.89,"secondCharact":3.38,"thirdCharact":18.3},{"name":"Bulgaria","firstCharact":21.4,"secondCharact":0.452,"thirdCharact":11.3}]},{"year":2015,"countries":[{"name":"Romania","firstCharact":25.2,"secondCharact":2.59,"thirdCharact":13.1},{"name":"Ungaria","firstCharact":40,"secondCharact":1.88,"thirdCharact":18.4},{"name":"Bulgaria","firstCharact":21.2,"secondCharact":2.21,"thirdCharact":11.7}]},{"year":2016,"countries":[{"name":"Romania","firstCharact":24,"secondCharact":2.05,"thirdCharact":14.7},{"name":"Ungaria","firstCharact":65,"secondCharact":0.959,"thirdCharact":18.4},{"name":"Bulgaria","firstCharact":19.1,"secondCharact":2.25,"thirdCharact":12.5}]},{"year":2017,"countries":[{"name":"Romania","firstCharact":24.4,"secondCharact":5.28,"thirdCharact":17},{"name":"Ungaria","firstCharact":109,"secondCharact":3.67,"thirdCharact":17.8},{"name":"Bulgaria","firstCharact":20.9,"secondCharact":1.18,"thirdCharact":15.67}]}]};
let canvas, context;
let getLateralDiv;
let countries;
let canvasW, canvasH;
let table;

document.addEventListener('DOMContentLoaded', app);

function app() {
    getLateralDiv = document.getElementById('lateral-bar');
    table = document.querySelector("table");

    initCanvas();

    let btnDrawHistogram = document.querySelector('#btnHistogram');
    btnDrawHistogram.addEventListener('click', initHistogramInterface);

    let btnClearCanvas = document.querySelector('#btnClearHistogram');
    btnClearCanvas.addEventListener('click', clearCanvas);
    

    let paragraf = document.querySelector('#graficParagraf');
    paragraf.append(addDropwdown('selectYears'));
    let selectYears = document.querySelector('#selectYears');
    populateDropDown(selectYears, getYearsFromJson());

    selectYears.addEventListener('mouseup',()=>{
        const selectedYear = selectYears.options[selectYears.value].text;
        console.log(getDataByYear(parseInt(selectedYear)));
        createTable();
    });
}

//method for init components in the user interface
function initHistogramInterface() {
    //show canvas 
    canvas.style.display = "block";
    table.style.display = "none";
    //check if there are already 3 components; 
    //in case we click the button histogram, this will put only once the needed components
    if (getLateralDiv.children.length === 3) {
        if (getLateralDiv.children.length < 4) {
            getLateralDiv.appendChild(addDropwdown( "selectCharact"));
            getLateralDiv.appendChild(addDropwdown("selectCountry"));
        }

        //get countries
        countries = getCountriesFromJson();

        //get select and populate them with the data from json
        let selectCharact = document.querySelector('#selectCharact');
        populateDropDown(selectCharact, dataJson.options);

        let selectCountry = document.querySelector("#selectCountry");
        populateDropDown(selectCountry, countries);

        //check for changes in the way canvas is designed
        selectCharact.addEventListener('mouseup', () => {
            firstDropdownSelected = selectCharact.value;
            //error handler pentru cand se alege doar o data
            // console.log(parseInt(firstDropdownSelected) === 1);
            // if we don't select de default dropdown
            selectCountry.addEventListener('mouseup', () => {
                secondDropDown = selectCountry.value;
                draw(firstDropdownSelected, secondDropDown);
            });
        })
    }
}


function createTable(){
    // hide canvas
    canvas.style.display = "none";
    table.style.display = "block"

}

// method draws the histogram given the selected values
function draw(charactSelectValue, countrySelectValue) {
    const countryName = countries[countrySelectValue];
    let countryData = []
    if (parseInt(charactSelectValue) === 1) {
        dataJson.data.map(year => {
            year.countries.map(indexCountry => {
                if (indexCountry.name === countryName) {
                    countryData.push(indexCountry.firstCharact);
                }
            })
        });
        drawHistogramContent(countryData);
    }

    if (parseInt(charactSelectValue) === 2) {
        dataJson.data.map(year => {
            year.countries.map(indexCountry => {
                if (indexCountry.name === countryName) {
                    countryData.push(indexCountry.secondCharact);
                }
            })
        });
        drawHistogramContent(countryData);
    }

    if (parseInt(charactSelectValue) === 3) {
        dataJson.data.map(year => {
            year.countries.map(indexCountry => {
                if (indexCountry.name === countryName) {
                    countryData.push(indexCountry.thirdCharact);
                }
            })
        });
        drawHistogramContent(countryData);
    }
}

// clears canvas
// todo: remove selects and buttons in the interface
function clearCanvas() {
    console.log("Canvas cleared")
    context.clearRect(0, 0, canvasW, canvasW);
    context.strokeStyle = "black";
    context.fillStyle = "black";
}

// method that draws the histogram; initial phase without data
function drawHistogramContent(data) {
    context.clearRect(0, 0, canvasW, canvasH);

    drawBasicCanvasBackground('white', 'black');

    context.fillRect(0, 0, canvasW, canvasH);
    context.strokeRect(0, 0, canvasW, canvasH);


    context.fillStyle = 'orange';
    context.beginPath();

    const number = data.length;
    const widthMedia = canvasW / number;
    const heightUnit = canvasH / Math.max(...data);

    for (let step = 0; step < number; step++) {
        let heightPerData = data[step] * heightUnit;
        context.rect(widthMedia * step, canvasH - heightPerData, widthMedia, heightPerData);
    }

    context.fill();
    context.lineWidth = 1;
    context.stroke();
}

// method that adds a dropdown to the lateral div
function addDropwdown( id) {
    let select = document.createElement('select');
    select.id = id;
    return select;
}

// method that populates the dropdown's values with given data
function populateDropDown(dropdown, data) {
    let index = 0;
    for (let option in data) {
        var op = new Option();
        op.value = index++;
        op.text = data[option];
        dropdown.add(op)
    }

    dropdown.style.display = "block"
    dropdown.style.margin = "10 auto"
}

function getCountriesFromJson() {
    const countries = [];
    dataJson.data.map(year => {
        year.countries.map(country => {
            index = countries.indexOf(country.name)
            countries[index] !== country.name ? countries.push(country.name) : null
        })
    })
    return countries;
}

function getYearsFromJson() {
    const years = [];
    dataJson.data.map(data => {
        years.push(data.year);
    })
    return years;
}

function getDataByYear(year){
    console.log("Data from " + year)
    const dataByYear = [];
    dataJson.data.map(data=>{
        if(data.year===year){
            dataByYear.push(data.countries);
        }
    });
    return dataByYear;
}

// draws the canvas background
function drawBasicCanvasBackground(fillColor, strokeStyle) {
    context.fillStyle = fillColor;
    context.strokeStyle = strokeStyle;
    context.lineWidth = 0;
}

// get the data for canvas
function initCanvas() {
    canvas = document.querySelector('canvas');
    context = canvas.getContext('2d');
    canvasH = canvas.height;
    canvasW = canvas.width;
}